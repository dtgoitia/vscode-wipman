# visualize and edit with sequencediagram.org
title Add Task inline in View

actor User

participant handleViewFileUpdated
participant "TransactionManager" as Transaction
participant "TaskManager" as Task
participant "ViewManager" as View
participant "FileManager" as File

note over User: edit view file
note over User: save view file

activate handleViewFileUpdated
handleViewFileUpdated->View:getView(view.id)
View-->handleViewFileUpdated:last View
note over handleViewFileUpdated: extract Task IDs from last View
note over handleViewFileUpdated: find Tasks deleted from View
note over handleViewFileUpdated: find Tasks added to View

  loop for each Task to add
    note over handleViewFileUpdated,File:(documented elsewhere)
  end

  loop for each Task to delete
    handleViewFileUpdated->Task:removeTask(taskId)
    activate Task
      note over Task:remove Task from index
      note over Task:delete Task
      Task-->View:TaskDeleted(taskId)

      activate View
        note over View:find Views that have Task
        
        loop for View that has Task
          note over View:update index to\nremove Task from View
          note over View:remove Task from View.content
          View-->File:TaskRemovedFromView {viewId, taskId} 
          activate File
            note over File:read View file
            note over File:delete Task from View file
            note over File:update View file
            File->View:updateView(view)
            note over View:get last View
            note over View:compare last and updated
            note over View:no index should update
            note over View:no task should be updated
            File-->]:FileUpdated
          deactivate File
        end
      deactivate View

      Task-->File:TaskDeleted(taskId)
      activate File
        note over File:delete Task file
        note over File:delete Task folder if empty
        File-->]:FileDeleted
      deactivate File
    deactivate Task
  end
  
  note over handleViewFileUpdated: read View from View file
  note over handleViewFileUpdated: update View

deactivate handleViewFileUpdated
